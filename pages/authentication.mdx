import SignatureGenerator from "../src/SignatureGenerator";

# Authentication

ARP Digital GPS API uses HMAC SHA256 signature-based authentication to ensure secure access to all endpoints.

## Overview

Every API request must include the following headers:

- `X-API-Key`: Your unique API key
- `X-Timestamp`: Current Unix timestamp in seconds
- `X-Signature`: HMAC SHA256 signature

## Signature Generation

The signature is calculated using HMAC SHA256 with the following formula:

```
signature = HMAC-SHA256(apiSecret, apiKey + requestBody + timestamp)
```

### Step-by-Step Process

1. **Get current timestamp**: Unix timestamp in seconds
2. **Prepare the message**: Concatenate `apiKey + requestBody + timestamp`
3. **Generate signature**: Create HMAC SHA256 hash using your API secret as the key
4. **Include headers**: Add all required headers to your request

## Code Examples

### JavaScript/Node.js

```javascript
import crypto from "crypto";

function generateSignature(apiKey, apiSecret, requestBody, timestamp) {
  // Convert timestamp to string if it's a number
  const timestampStr = timestamp.toString();

  // Create the message to sign
  const message = apiKey + requestBody + timestampStr;

  // Generate HMAC SHA256 signature
  const signature = crypto
    .createHmac("sha256", apiSecret)
    .update(message)
    .digest("hex");

  return signature;
}

// Example usage
async function makeApiRequest(endpoint, requestBody = "") {
  const apiKey = "your_api_key_here";
  const apiSecret = "your_api_secret_here"; // Used only for signature generation
  const timestamp = Math.floor(Date.now() / 1000);
  const signature = generateSignature(
    apiKey,
    apiSecret,
    requestBody,
    timestamp
  );

  const response = await fetch(`https://platform.arpdigital.io/services${endpoint}`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-API-Key": apiKey,
      "X-Timestamp": timestamp.toString(),
      "X-Signature": signature,
    },
    body: requestBody,
  });

  return response.json();
}

// Example: Get a quote
const quoteRequest = JSON.stringify({
  fromCurrency: "USD",
  toCurrency: "PHP",
  fromAmount: 100,
});

makeApiRequest("/quote", quoteRequest)
  .then(data => console.log("Quote:", data))
  .catch(error => console.error("Error:", error));
```

### Python

```python
import hmac
import hashlib
import time
import json
import requests

def generate_signature(api_key, api_secret, request_body, timestamp):
    """Generate HMAC SHA256 signature for API authentication"""
    # Create the message to sign
    message = api_key + request_body + str(timestamp)

    # Generate HMAC SHA256 signature
    signature = hmac.new(
        api_secret.encode('utf-8'),
        message.encode('utf-8'),
        hashlib.sha256
    ).hexdigest()

    return signature

def make_api_request(endpoint, request_body=''):
    """Make authenticated API request"""
    api_key = 'your_api_key_here'
    api_secret = 'your_api_secret_here'  # Used only for signature generation
    timestamp = int(time.time())

    signature = generate_signature(api_key, api_secret, request_body, timestamp)

    headers = {
        'Content-Type': 'application/json',
        'X-API-Key': api_key,
        'X-Timestamp': str(timestamp),
        'X-Signature': signature
    }

    response = requests.post(
        <!-- f'https://gps.arpdigital.io/api/v1{endpoint}', -->
        f'https://platform.arpdigital.io/api/v1{endpoint}',
        headers=headers,
        data=request_body
    )

    return response.json()

# Example: Get a quote
quote_request = json.dumps({
    'fromCurrency': 'USD',
    'toCurrency': 'PHP',
    'fromAmount': 100
})

try:
    result = make_api_request('/quote', quote_request)
    print('Quote:', result)
except Exception as error:
    print('Error:', error)
```

### PHP

```php
<?php

function generateSignature($apiKey, $apiSecret, $requestBody, $timestamp) {
    // Create the message to sign
    $message = $apiKey . $requestBody . $timestamp;

    // Generate HMAC SHA256 signature
    return hash_hmac('sha256', $message, $apiSecret);
}

function makeApiRequest($endpoint, $requestBody = '') {
    $apiKey = 'your_api_key_here';
    $apiSecret = 'your_api_secret_here'; // Used only for signature generation
    $timestamp = time();

    $signature = generateSignature($apiKey, $apiSecret, $requestBody, $timestamp);

    $headers = [
        'Content-Type: application/json',
        'X-API-Key: ' . $apiKey,
        'X-Timestamp: ' . $timestamp,
        'X-Signature: ' . $signature
    ];

    $curl = curl_init();
    curl_setopt_array($curl, [
        CURLOPT_URL => 'https://gps.arpdigital.io/api/v1' . $endpoint,
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_POST => true,
        CURLOPT_POSTFIELDS => $requestBody,
        CURLOPT_HTTPHEADER => $headers
    ]);

    $response = curl_exec($curl);
    curl_close($curl);

    return json_decode($response, true);
}

// Example: Get a quote
$quoteRequest = json_encode([
    'fromCurrency' => 'USD',
    'toCurrency' => 'PHP',
    'fromAmount' => 100
]);

$result = makeApiRequest('/quote', $quoteRequest);
echo 'Quote: ' . print_r($result, true);
?>
```

### cURL

```bash
#!/bin/bash

API_KEY="your_api_key_here"
API_SECRET="your_api_secret_here"
TIMESTAMP=$(date +%s)
REQUEST_BODY='{"fromCurrency":"USD","toCurrency":"PHP","fromAmount":100}'

# Generate signature (requires openssl)
MESSAGE="${API_KEY}${REQUEST_BODY}${TIMESTAMP}"
SIGNATURE=$(echo -n "$MESSAGE" | openssl dgst -sha256 -hmac "$API_SECRET" -hex | sed 's/^.* //')

curl -X POST "https://gps.arpdigital.io/api/v1/quote" \
  -H "Content-Type: application/json" \
  -H "X-API-Key: $API_KEY" \
  -H "X-Timestamp: $TIMESTAMP" \
  -H "X-Signature: $SIGNATURE" \
  -d "$REQUEST_BODY"
```

## Interactive Signature Generator

<SignatureGenerator />

## Important Notes

### Timestamp Validation

- Timestamps must be within 1000 seconds (16.67 minutes) of the server time
- Use Unix timestamp in seconds, not milliseconds

### Request Body Handling

- For GET requests with no body, use an empty string `""`
- For POST/PUT requests, use the exact JSON string that will be sent
- Ensure consistent encoding (UTF-8)

### Common Errors

#### Invalid Signature (403 Forbidden)

- Check that your API secret is correct
- Verify the message format: `apiKey + requestBody + timestamp`
- Ensure timestamp is in seconds, not milliseconds

#### Timestamp Too Old (403 Forbidden)

- Generate a fresh timestamp for each request
- Check your system clock synchronization

#### Missing Headers (403 Forbidden)

- Ensure all required headers are present:
  - `X-API-Key`
  - `X-Timestamp`
  - `X-Signature`

## Testing Your Implementation

Use our signature validation endpoint to test your implementation:

```javascript
// Test endpoint for signature validation
const testSignature = async () => {
  const response = await makeApiRequest("/test-auth", "");
  console.log("Auth test result:", response);
};
```

If your signature generation is correct, you should receive a success response. If not, check the error message for guidance on what might be wrong.

## Security Best Practices

1. **Never expose your API secret** in client-side code
2. **Rotate your API keys** regularly
3. **Use HTTPS** for all API requests
4. **Implement proper error handling** for authentication failures
5. **Store credentials securely** using environment variables or secure vaults
